name: "ğŸ” Domain ve BaseURL GÃ¼ncelle"
on:
  # Manuel Ã§alÄ±ÅŸtÄ±rma iÃ§in tetikleyici
  workflow_dispatch:
  # Otomatik Ã§alÄ±ÅŸma iÃ§in zamanlayÄ±cÄ± (30 dakikada bir)
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  guncelle:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—‚ï¸ Repoyu Ana DalÄ±ndan Ã‡ek
        uses: actions/checkout@v4
        with:
          # HEMEN DÄ°KKAT: Bu satÄ±r Ã§ok Ã¶nemli.
          # `main` yerine repo'nun varsayÄ±lan dal adÄ±nÄ± yaz.
          # Genellikle `main` veya `master` olur.
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Python Kurulumu
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Gerekli KÃ¼tÃ¼phaneyi YÃ¼kle
        run: pip install requests

      - name: ğŸ§  AkÄ±llÄ± Kontrol ve GÃ¼ncelleme
        run: |
          # ---------- 1. MEVCUT DOMAÄ°N DOSYASINI OKU ----------
          if [ -f "domain.txt" ]; then
            # Eski usul grep ile satÄ±rÄ± bulup '=' ile ayÄ±r
            CURRENT_DOMAIN=$(grep '^guncel_domain=' domain.txt | cut -d'=' -f2-)
            echo "ğŸ“‚ Dosyadan okunan domain: $CURRENT_DOMAIN"
          else
            CURRENT_DOMAIN="https://trgoals1423.xyz/"
            echo "âš ï¸ domain.txt yok, varsayÄ±lan kullanÄ±lÄ±yor: $CURRENT_DOMAIN"
          fi

          # ---------- 2. DOMAÄ°N NUMARASINI Ã‡IKART ----------
          # SayÄ±yÄ± gÃ¼venli bir ÅŸekilde al
          DOMAIN_NUMBER=$(echo "$CURRENT_DOMAIN" | grep -Eo '[0-9]+' | head -1)
          echo "ğŸ”¢ Mevcut Domain NumarasÄ±: ${DOMAIN_NUMBER:-1423}"

          # ---------- 3. PREFORMANCE DEÄÄ°ÅKENLERÄ° ----------
          export CURRENT_DOMAIN
          export DOMAIN_NUMBER

          # ---------- 4. ANA PYTHON KODU ----------
          python3 << 'EOF'
import requests
import re
import os
import sys

headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}

def is_domain_alive(url):
    """Domain'in eriÅŸilebilir olup olmadÄ±ÄŸÄ±nÄ± kontrol et."""
    try:
        r = requests.get(url, headers=headers, timeout=7, allow_redirects=True)
        return r.status_code == 200
    except:
        return False

def fetch_with_proxy(url):
    """Ã–nce direkt dene, olmazsa proxy ile dene."""
    try:
        r = requests.get(url, headers=headers, timeout=10)
        return r.text
    except:
        proxy_url = f"https://api.codetabs.com/v1/proxy/?quest={url}"
        try:
            r = requests.get(proxy_url, headers=headers, timeout=15)
            return r.text
        except Exception as e:
            print(f"âŒ Proxy de baÅŸarÄ±sÄ±z: {e}")
            return None

def extract_base_url(html):
    """HTML'den baseUrl'i SENÄ°N istediÄŸin regex ile Ã§Ä±kar."""
    # Pattern 1: SENÄ°N gÃ¶sterdiÄŸin tam yapÄ±
    pattern1 = r"CONFIG\s*=\s*{[^}]*baseUrl\s*:\s*['\"](https?://[^'\"]+)['\"]"
    # Pattern 2: Yedek, sbs ile biten URL
    pattern2 = r"baseUrl\s*:\s*['\"](https?://[^'\"]+\.sbs)['\"]"

    match = re.search(pattern1, html, re.IGNORECASE | re.DOTALL)
    if not match:
        match = re.search(pattern2, html, re.IGNORECASE)
    return match.group(1) if match else None

# --- BAÅLANGIÃ‡ ---
print("ğŸš€ Ä°ÅŸlem baÅŸlatÄ±lÄ±yor...")
current_domain = os.environ.get('CURRENT_DOMAIN', '').rstrip('/')
domain_num = int(os.environ.get('DOMAIN_NUMBER', 1423))

# --- A. MEVCUT DOMAÄ°N KONTROLÃœ ---
print(f"\nğŸ” Mevcut domain kontrol ediliyor: {current_domain}")
if is_domain_alive(current_domain):
    print("âœ… Mevcut domain Ã§alÄ±ÅŸÄ±yor.")
    target_domain = current_domain
else:
    # --- B. YENÄ° DOMAÄ°N BULMA ---
    print("ğŸ”„ Mevcut domain Ã§alÄ±ÅŸmÄ±yor, yeni aranÄ±yor...")
    found = False
    for i in range(1, 51):  # Maksimum 50 deneme
        test_num = domain_num + i
        test_domain = f"https://trgoals{test_num}.xyz/"
        print(f"   Deneme {i}/50: {test_domain}", end="")
        if is_domain_alive(test_domain):
            print(" -> âœ… BULUNDU!")
            target_domain = test_domain
            found = True
            # HEMEN domain.txt'ye YAZ
            with open('domain.txt', 'w') as f:
                f.write(f'guncel_domain={target_domain}')
            print(f"   ğŸ“ domain.txt gÃ¼ncellendi.")
            break
        else:
            print(" -> âŒ Ã‡alÄ±ÅŸmÄ±yor")
    if not found:
        print("âŒ 50 denemede Ã§alÄ±ÅŸan domain bulunamadÄ±. Ä°ÅŸlem durduruldu.")
        sys.exit(1)

# --- C. channel.html'DEN BASEURL Ã‡EKME ---
channel_url = f"{target_domain.rstrip('/')}/channel.html"
print(f"\nğŸŒ channel.html isteniyor: {channel_url}")
html = fetch_with_proxy(channel_url)

if not html:
    print("âŒ channel.html alÄ±namadÄ±. baseURL bulunamadÄ±.")
    sys.exit(1)

base_url = extract_base_url(html)
if base_url:
    print(f"ğŸ¯ BaseURL bulundu: {base_url}")
    with open('guncel_baseurl.txt', 'w') as f:
        f.write(f'guncel_baseurl={base_url}')
    print("ğŸ’¾ guncel_baseurl.txt dosyasÄ±na yazÄ±ldÄ±.")
else:
    print("âš ï¸  HTML'de baseUrl bulunamadÄ±.")

print("\nâœ¨ Ä°ÅŸlem tamamlandÄ±.")
EOF

      - name: ğŸ“ DeÄŸiÅŸiklikleri Kontrol Et ve Kaydet
        if: always()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"
          
          # Hangi dosyalar deÄŸiÅŸti?
          echo "ğŸ“Š DeÄŸiÅŸen dosyalar:"
          git status --porcelain
          
          # DeÄŸiÅŸiklik varsa commit et ve push yap
          if [[ -n $(git status --porcelain) ]]; then
            echo "ğŸ’¾ DeÄŸiÅŸiklikler kaydediliyor..."
            git add domain.txt guncel_baseurl.txt 2>/dev/null || true
            git commit -m "ğŸ¤– Otomatik gÃ¼ncelleme: Domain ve BaseURL"
            git push
            echo "âœ… DeÄŸiÅŸiklikler ana dala gÃ¶nderildi."
          else
            echo "â„¹ï¸  DeÄŸiÅŸiklik yok, commit atÄ±lmadÄ±."
          fi
