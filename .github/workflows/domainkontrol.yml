name: Domain and Base URL Check and Update
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-and-update-domain:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: pip install requests

    - name: Smart Domain and Base URL Check and Update
      run: |
        # Mevcut domaini al veya varsayÄ±lanÄ± kullan
        if [ -f "domain.txt" ]; then
          CURRENT_DOMAIN=$(grep -o 'guncel_domain=.*' domain.txt | cut -d'=' -f2)
          echo "Mevcut domain: $CURRENT_DOMAIN"
        else
          CURRENT_DOMAIN="https://trgoals1423.xyz/"
          echo "Yeni domain.txt oluÅŸturuluyor: $CURRENT_DOMAIN"
          echo "guncel_domain=$CURRENT_DOMAIN" > domain.txt
        fi

        # Domain numarasÄ±nÄ± al
        DOMAIN_NUMBER=$(echo $CURRENT_DOMAIN | grep -o '[0-9]\+')
        echo "BaÅŸlangÄ±Ã§ domain numarasÄ±: $DOMAIN_NUMBER"

        # AkÄ±llÄ± domain ve base URL kontrolÃ¼ iÃ§in Python scripti - TIRNAKLARI DÃœZELTTÄ°M
        python3 -c '
import requests
import os
import re
        
# GerÃ§ekÃ§i bir User-Agent baÅŸlÄ±ÄŸÄ± tanÄ±mla
headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36"
}
        
def check_domain(domain_number):
    """Domain numarasÄ±nÄ± artÄ±rarak Ã§alÄ±ÅŸan domaini bul"""
    base_domain = "trgoals"
    max_attempts = 20
    found_domain = None
    
    for i in range(max_attempts):
        test_number = int(domain_number) + i
        test_domain = f"https://{base_domain}{test_number}.xyz/"
        
        try:
            print(f"Test ediliyor: {test_domain}")
            # Ã–nce doÄŸrudan istek at
            response = requests.get(test_domain, headers=headers, timeout=10)
            
            if response.status_code == 200:
                print(f"âœ… Ã‡alÄ±ÅŸan domain bulundu: {test_domain}")
                found_domain = test_domain
                
                # Channel.html sayfasÄ±nÄ± kontrol et
                channel_url = test_domain.rstrip("/") + "/channel.html"
                print(f"Channel.html kontrol ediliyor: {channel_url}")
                
                try:
                    channel_response = requests.get(channel_url, headers=headers, timeout=10)
                    if channel_response.status_code == 200:
                        print(f"âœ… Channel.html eriÅŸilebilir")
                        return test_domain, channel_url, channel_response.text
                    else:
                        print(f"âš  Channel.html {channel_response.status_code} hatasÄ±")
                        # Proxy ile tekrar dene
                        proxy_url = f"https://api.codetabs.com/v1/proxy/?quest={channel_url}"
                        print(f"Proxy ile deneme: {proxy_url}")
                        
                        proxy_response = requests.get(proxy_url, headers=headers, timeout=15)
                        if proxy_response.status_code == 200:
                            print(f"âœ… Proxy Ã¼zerinden channel.html eriÅŸilebilir")
                            return test_domain, channel_url, proxy_response.text
                except Exception as e:
                    print(f"âš  Channel.html hatasÄ±: {e}")
                    # Proxy ile tekrar dene
                    try:
                        proxy_url = f"https://api.codetabs.com/v1/proxy/?quest={channel_url}"
                        print(f"Proxy ile tekrar deneme: {proxy_url}")
                        
                        proxy_response = requests.get(proxy_url, headers=headers, timeout=15)
                        if proxy_response.status_code == 200:
                            print(f"âœ… Proxy Ã¼zerinden channel.html eriÅŸilebilir")
                            return test_domain, channel_url, proxy_response.text
                    except Exception as e2:
                        print(f"âš  Proxy hatasÄ±: {e2}")
                
                return test_domain, None, None
                        
        except requests.RequestException as e:
            print(f"âŒ Domain Ã§alÄ±ÅŸmÄ±yor: {test_domain} - Hata: {e}")
            continue
    
    return None, None, None

def extract_base_url(html_content):
    """HTML iÃ§inden base URLyi regex ile Ã§Ä±kar"""
    try:
        if not html_content:
            return None
            
        # Regex patterni: CONFIG={baseUrl: ile baÅŸlayan, https ile baÅŸlayan ve .sbs/ ile biten URL
        pattern = r"CONFIG\s*=\s*\{baseUrl\s*:\s*['\"](https?://[^'\"]+\.sbs/)['\"]"
        match = re.search(pattern, html_content)
        
        if match:
            base_url = match.group(1)
            print(f"âœ… Base URL bulundu: {base_url}")
            return base_url
        
        # Alternatif pattern: const CONFIG={baseUrl: ile baÅŸlayan
        pattern2 = r"const\s+CONFIG\s*=\s*\{baseUrl\s*:\s*['\"](https?://[^'\"]+\.sbs/)['\"]"
        match2 = re.search(pattern2, html_content)
        
        if match2:
            base_url = match2.group(1)
            print(f"âœ… Base URL bulundu (alternatif): {base_url}")
            return base_url
        
        print("âš  Base URL bulunamadÄ±")
        return None
                
    except Exception as e:
        print(f"âš  Base URL Ã§Ä±karma hatasÄ±: {e}")
        return None

def update_files(domain, base_url):
    """Domain ve base URL dosyalarÄ±nÄ± gÃ¼ncelle"""
    if domain:
        with open("domain.txt", "w") as f:
            f.write(f"guncel_domain={domain}")
        print(f"ğŸ“ domain.txt gÃ¼ncellendi: {domain}")
    
    if base_url:
        with open("guncel_baseurl.txt", "w") as f:
            f.write(f"guncel_baseurl={base_url}")
        print(f"ğŸ“ guncel_baseurl.txt gÃ¼ncellendi: {base_url}")

# Ana iÅŸlem
import sys
domain_number = sys.argv[1] if len(sys.argv) > 1 else "'"$DOMAIN_NUMBER"'"
if not domain_number:
    domain_number = "1423"

print(f"BaÅŸlangÄ±Ã§ domain numarasÄ±: {domain_number}")

found_domain, channel_url, html_content = check_domain(domain_number)

if found_domain:
    base_url = None
    if html_content:
        base_url = extract_base_url(html_content)
    
    update_files(found_domain, base_url)
    
    # Ä°leride kullanÄ±lmak Ã¼zere channel URL'sini de kaydet
    if channel_url:
        print(f"ğŸ”— Channel URL: {channel_url}")
else:
    print("âŒ Ã‡alÄ±ÅŸan domain bulunamadÄ±")
        '
        
        # DeÄŸiÅŸiklikleri commit et
    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add domain.txt guncel_baseurl.txt
        if git diff --staged --quiet; then
          echo "DeÄŸiÅŸiklik yok"
        else
          git commit -m "Domain ve base URL gÃ¼ncellendi"
          git push
        fi
