name: "ğŸ”— BaseURL Ã‡ekici"
on:
  # MANUEL Ã‡ALIÅTIRMA iÃ§in (senin tÄ±klayacaÄŸÄ±n buton)
  workflow_dispatch:
  # OTOMATÄ°K Ã‡ALIÅMA iÃ§in (30 dakikada bir)
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  get-baseurl:
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Repository'yi Ã‡ek"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          # DÄ°KKAT: Ana dal adÄ±nÄ± doÄŸru yaz! (main veya master)
          ref: main

      - name: "ğŸ Python Kur"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "ğŸ“¦ requests KÃ¼tÃ¼phanesini YÃ¼kle"
        run: pip install requests

      - name: "ğŸ¯ BaseURL'i Ã‡ek ve Kaydet"
        run: |
          python3 << 'EOF'
import requests
import re
import os
import sys

headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}

print("="*50)
print("ğŸš€ BaseURL Ã‡ekici BaÅŸladÄ±")
print("="*50)

# 1. domain.txt DOSYASINI OKU
try:
    with open('domain.txt', 'r') as f:
        content = f.read()
    # guncel_domain=https://... formatÄ±ndan URL'yi Ã§ek
    match = re.search(r'guncel_domain=(https?://[^\s]+)', content)
    if match:
        domain = match.group(1).strip().rstrip('/')
        print(f"âœ… domain.txt bulundu: {domain}")
    else:
        print("âŒ domain.txt'de 'guncel_domain=' bulunamadÄ±!")
        sys.exit(1)
except FileNotFoundError:
    print("âŒ domain.txt dosyasÄ± bulunamadÄ±!")
    sys.exit(1)

# 2. channel.html URL'YÄ° HAZIRLA
channel_url = f"{domain}/channel.html"
print(f"\nğŸ”— Hedef URL: {channel_url}")

# 3. Ä°STEÄÄ° YAP (Ã–NCE NORMAL, SONRA PROXY)
def fetch_url(url):
    """Ã–nce normal dene, olmazsa proxy ile dene"""
    print(f"   ğŸ”„ Normal istek deneniyor...")
    try:
        r = requests.get(url, headers=headers, timeout=10)
        print(f"   âœ… Normal istek baÅŸarÄ±lÄ± (Status: {r.status_code})")
        return r.text
    except Exception as e:
        print(f"   âŒ Normal istek baÅŸarÄ±sÄ±z: {e}")
        proxy_url = f"https://api.codetabs.com/v1/proxy/?quest={url}"
        print(f"   ğŸ”„ Proxy ile deneniyor...")
        try:
            r = requests.get(proxy_url, headers=headers, timeout=15)
            print(f"   âœ… Proxy isteÄŸi baÅŸarÄ±lÄ± (Status: {r.status_code})")
            return r.text
        except Exception as e2:
            print(f"   âŒ Proxy de baÅŸarÄ±sÄ±z: {e2}")
            return None

html = fetch_url(channel_url)
if not html:
    print("\nâŒ HTML iÃ§eriÄŸi alÄ±namadÄ±. Ä°ÅŸlem sonlandÄ±rÄ±lÄ±yor.")
    sys.exit(1)

print(f"\nğŸ“„ HTML alÄ±ndÄ± ({len(html)} karakter)")

# 4. 3 FARKLI REGEX Ä°LE BASEURL ARA
print("\nğŸ” BaseURL aranÄ±yor...")
baseurl = None

# REGEX 1: TAM SENÄ°N GÃ–STERDÄ°ÄÄ°N YAPI
pattern1 = r"<script>\(function\(\)\{const CONFIG=\{baseUrl:'(https?://[^']+\.sbs)/'"
match1 = re.search(pattern1, html, re.IGNORECASE)
if match1:
    baseurl = match1.group(1)
    print(f"   âœ… Regex 1 ile bulundu: {baseurl}")

# REGEX 2: CONFIG={baseUrl:'...' (daha genel)
if not baseurl:
    pattern2 = r"CONFIG\s*=\s*{[^}]*baseUrl\s*:\s*['\"](https?://[^'\"]+\.sbs)"
    match2 = re.search(pattern2, html, re.IGNORECASE | re.DOTALL)
    if match2:
        baseurl = match2.group(1)
        print(f"   âœ… Regex 2 ile bulundu: {baseurl}")

# REGEX 3: TÃ¼m HTML'de https://... ile baÅŸlayÄ±p .sbs ile biten
if not baseurl:
    pattern3 = r'(https?://[^\s<>"\']+\.sbs)'
    matches3 = re.findall(pattern3, html)
    # En uzun URL'yi seÃ§ (bÃ¼yÃ¼k ihtimalle doÄŸru olan)
    if matches3:
        baseurl = max(matches3, key=len)
        print(f"   âœ… Regex 3 ile bulundu: {baseurl}")

# 5. SONUÃ‡
if baseurl:
    baseurl = baseurl.rstrip('/')  # Sonundaki slash'Ä± temizle
    print(f"\nğŸ‰ BASEURL BULUNDU: {baseurl}")
    
    # guncel_baseurl.txt DOSYASINA YAZ
    with open('guncel_baseurl.txt', 'w') as f:
        f.write(f'guncel_baseurl={baseurl}')
    print(f"ğŸ’¾ guncel_baseurl.txt dosyasÄ±na yazÄ±ldÄ±.")
    
    # Ek kontrol: DosyayÄ± oku ve gÃ¶ster
    with open('guncel_baseurl.txt', 'r') as f:
        print(f"ğŸ“‹ Dosya iÃ§eriÄŸi: {f.read().strip()}")
else:
    print("\nâŒ HiÃ§bir regex ile BaseURL bulunamadÄ±!")
    print("   HTML'deki olasÄ± adaylar:")
    # https ile baÅŸlayan tÃ¼m URL'leri gÃ¶ster
    all_urls = re.findall(r'(https?://[^\s<>"\']+)', html)
    for url in all_urls[:10]:  # Ä°lk 10'u gÃ¶ster
        if '.sbs' in url:
            print(f"   - {url}")
    sys.exit(1)

print("\n" + "="*50)
print("âœ¨ BaseURL Ã‡ekici TamamlandÄ±")
print("="*50)
EOF

      - name: "ğŸ“ DeÄŸiÅŸiklikleri Kontrol Et ve Kaydet"
        if: always()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions Bot"
          
          echo "ğŸ“Š DeÄŸiÅŸen dosyalar:"
          git status --porcelain
          
          # SADECE guncel_baseurl.txt deÄŸiÅŸtiyse kaydet
          if [[ -f "guncel_baseurl.txt" ]]; then
            if git diff --quiet guncel_baseurl.txt; then
              echo "â„¹ï¸  guncel_baseurl.txt'de deÄŸiÅŸiklik yok."
            else
              echo "ğŸ’¾ DeÄŸiÅŸiklikler kaydediliyor..."
              git add guncel_baseurl.txt
              git commit -m "ğŸ”— BaseURL gÃ¼ncellendi: $(date '+%Y-%m-%d %H:%M')"
              git push
              echo "âœ… DeÄŸiÅŸiklikler gÃ¶nderildi."
            fi
          else
            echo "âš ï¸  guncel_baseurl.txt oluÅŸturulamadÄ±."
          fi
