name: "ğŸ”— BaseURL GÃ¼ncelleyici"  # BURASI ACTIONSLARDA GÃ–ZÃœKECEK Ä°SÄ°M
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  get-baseurl:
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“¥ Repository'yi Ã‡ek"
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "ğŸ Python Kur"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "ğŸ“¦ Gerekli KÃ¼tÃ¼phaneler"
        run: pip install requests

      - name: "ğŸ¯ BaseURL'i Ã‡ek"
        run: |
          python3 << 'EOF'
import requests
import re
import sys

headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}

print("ğŸš€ BAÅLANGIÃ‡: BaseURL Ã‡ekiliyor")

# 1. domain.txt'den URL'yi oku
try:
    with open('domain.txt', 'r') as f:
        for line in f:
            if line.startswith('guncel_domain='):
                domain = line.strip().split('=', 1)[1].rstrip('/')
                print(f"âœ… Domain bulundu: {domain}")
                break
        else:
            print("âŒ domain.txt'de guncel_domain= bulunamadÄ±!")
            sys.exit(1)
except:
    print("âŒ domain.txt dosyasÄ± bulunamadÄ±!")
    sys.exit(1)

# 2. channel.html URL'sini hazÄ±rla
channel_url = f"{domain}/channel.html"
print(f"ğŸ”— Ä°stek atÄ±lacak: {channel_url}")

# 3. HTML'i al (Ã¶nce normal, sonra proxy)
def get_html(url):
    try:
        r = requests.get(url, headers=headers, timeout=8)
        print("âœ… Direk eriÅŸim baÅŸarÄ±lÄ±")
        return r.text
    except:
        print("ğŸ”„ Proxy deneniyor...")
        try:
            proxy_url = f"https://api.codetabs.com/v1/proxy/?quest={url}"
            r = requests.get(proxy_url, headers=headers, timeout=12)
            print("âœ… Proxy ile alÄ±ndÄ±")
            return r.text
        except Exception as e:
            print(f"âŒ Proxy de baÅŸarÄ±sÄ±z: {e}")
            return None

html = get_html(channel_url)
if not html:
    sys.exit(1)

# 4. BASEURL'i 3 FARKLI ÅEKÄ°LDE ARA
baseurl = None
patterns = [
    # Pattern 1: Senin gÃ¶sterdiÄŸin tam format
    r"CONFIG=\{baseUrl:'(https?://[^']+\.sbs)/'",
    # Pattern 2: Genel CONFIG pattern
    r"baseUrl\s*:\s*['\"](https?://[^'\"]+\.sbs)",
    # Pattern 3: TÃ¼m HTML'de .sbs ile biten URL
    r'(https?://[^\s<>"\']+\.sbs)'
]

pattern_names = ["Tam Format", "Genel CONFIG", ".sbs URL"]
for i, (pattern, name) in enumerate(zip(patterns, pattern_names), 1):
    match = re.search(pattern, html, re.IGNORECASE)
    if match:
        baseurl = match.group(1).rstrip('/')
        print(f"âœ… {name} ile bulundu: {baseurl}")
        break

if not baseurl:
    print("âŒ BaseURL bulunamadÄ±!")
    sys.exit(1)

# 5. DOSYAYA YAZ
with open('guncel_baseurl.txt', 'w') as f:
    f.write(f'guncel_baseurl={baseurl}')
print(f"ğŸ’¾ guncel_baseurl.txt'ye yazÄ±ldÄ±: {baseurl}")
EOF

      - name: "ğŸ“ DeÄŸiÅŸiklikleri Kaydet"
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          
          if [[ -f "guncel_baseurl.txt" ]]; then
            if ! git diff --quiet guncel_baseurl.txt; then
              git add guncel_baseurl.txt
              git commit -m "ğŸ”— BaseURL gÃ¼ncellendi"
              git push
              echo "âœ… BaseURL gÃ¼ncellendi ve push edildi"
            else
              echo "â„¹ï¸  DeÄŸiÅŸiklik yok"
            fi
          fi
