name: 'BaseURL GÃ¼ncelleyici'
on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

permissions:
  contents: write

jobs:
  update-baseurl:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ—‚ï¸ Repository'yi Ã‡ek
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Python Kur
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ“¦ KÃ¼tÃ¼phaneleri YÃ¼kle
        run: pip install requests

      - name: ğŸ“„ Python Scripti OluÅŸtur
        run: |
          cat > fetch_baseurl.py << 'EOF'
#!/usr/bin/env python3
import requests
import re
import os
import sys

USER_AGENT = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
TIMEOUT = 10
PROXY_URL = 'https://api.codetabs.com/v1/proxy/?quest='

def read_domain_from_file(filepath='domain.txt'):
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if line.startswith('guncel_domain='):
                    domain = line.split('=', 1)[1].strip()
                    if domain:
                        return domain.rstrip('/')
        print(f"âŒ HATA: {filepath} dosyasÄ±nda 'guncel_domain=' bulunamadÄ±.")
        return None
    except FileNotFoundError:
        print(f"âŒ HATA: {filepath} dosyasÄ± bulunamadÄ±.")
        return None
    except Exception as e:
        print(f"âŒ HATA: Dosya okunurken hata: {e}")
        return None

def fetch_html(url):
    headers = {'User-Agent': USER_AGENT}
    
    # 1. Direkt istek
    try:
        print(f"ğŸŒ Direkt istek deneniyor: {url}")
        response = requests.get(url, headers=headers, timeout=TIMEOUT)
        response.raise_for_status()
        print("âœ… Direkt istek baÅŸarÄ±lÄ±.")
        return response.text
    except requests.RequestException as e:
        print(f"âš ï¸  Direkt istek baÅŸarÄ±sÄ±z: {e}")
    
    # 2. Proxy ile istek
    try:
        proxy_full_url = PROXY_URL + url
        print(f"ğŸ” Proxy ile deneniyor: {proxy_full_url}")
        response = requests.get(proxy_full_url, headers=headers, timeout=TIMEOUT+5)
        response.raise_for_status()
        print("âœ… Proxy isteÄŸi baÅŸarÄ±lÄ±.")
        return response.text
    except requests.RequestException as e:
        print(f"âŒ Proxy isteÄŸi de baÅŸarÄ±sÄ±z: {e}")
    
    return None

def extract_baseurl(html):
    if not html:
        return None
    
    patterns = [
        r"<script>\(function\(\)\{const CONFIG=\{baseUrl:'(https?://[^']+\.sbs)/'",
        r"CONFIG\s*=\s*\{[^}]*baseUrl\s*:\s*['\"](https?://[^'\"]+\.sbs)",
        r'(https?://[^\s<>"\']+\.sbs)'
    ]
    
    for i, pattern in enumerate(patterns, 1):
        try:
            match = re.search(pattern, html, re.IGNORECASE)
            if match:
                baseurl = match.group(1).rstrip('/')
                print(f"âœ… Regex {i} ile bulundu: {baseurl}")
                return baseurl
        except Exception as e:
            print(f"âš ï¸  Regex {i} hatasÄ±: {e}")
            continue
    
    print("âŒ HiÃ§bir regex ile baseUrl bulunamadÄ±.")
    return None

def write_baseurl_to_file(baseurl, filepath='guncel_baseurl.txt'):
    try:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(f'guncel_baseurl={baseurl}')
        print(f"ğŸ’¾ {filepath} dosyasÄ±na yazÄ±ldÄ±: {baseurl}")
        return True
    except Exception as e:
        print(f"âŒ Dosya yazma hatasÄ±: {e}")
        return False

def main():
    print("="*60)
    print("ğŸš€ BaseURL Ã‡ekici BaÅŸlatÄ±lÄ±yor")
    print("="*60)
    
    print("\n1ï¸âƒ£  Domain okunuyor...")
    domain = read_domain_from_file()
    if not domain:
        sys.exit(1)
    
    print(f"   âœ… Domain: {domain}")
    
    channel_url = f"{domain}/channel.html"
    print(f"\n2ï¸âƒ£  Channel.html URL'si: {channel_url}")
    
    print("\n3ï¸âƒ£  HTML iÃ§eriÄŸi alÄ±nÄ±yor...")
    html = fetch_html(channel_url)
    if not html:
        print("âŒ HTML alÄ±namadÄ±. Ä°ÅŸlem sonlandÄ±rÄ±lÄ±yor.")
        sys.exit(1)
    
    print(f"   âœ… HTML alÄ±ndÄ± ({len(html)} karakter)")
    
    print("\n4ï¸âƒ£  BaseURL aranÄ±yor...")
    baseurl = extract_baseurl(html)
    if not baseurl:
        sys.exit(1)
    
    print("\n5ï¸âƒ£  Dosyaya yazÄ±lÄ±yor...")
    if write_baseurl_to_file(baseurl):
        print("\n" + "="*60)
        print("âœ¨ Ä°ÅLEM BAÅARIYLA TAMAMLANDI")
        print("="*60)
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == '__main__':
    main()
EOF

      - name: ğŸ¯ Scripti Ã‡alÄ±ÅŸtÄ±r
        run: python3 fetch_baseurl.py

      - name: ğŸ“ DeÄŸiÅŸiklikleri Kaydet
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ã–nce dosyanÄ±n oluÅŸup oluÅŸmadÄ±ÄŸÄ±nÄ± kontrol et
          if [ -f "guncel_baseurl.txt" ]; then
            echo "ğŸ“„ guncel_baseurl.txt dosyasÄ± bulundu"
            
            # DeÄŸiÅŸiklik var mÄ± kontrol et
            if git diff --quiet guncel_baseurl.txt; then
              echo "â„¹ï¸  DeÄŸiÅŸiklik yok, commit atÄ±lmÄ±yor"
            else
              git add guncel_baseurl.txt
              git commit -m "ğŸ¤– BaseURL gÃ¼ncellendi [skip ci]"
              git push
              echo "âœ… DeÄŸiÅŸiklikler kaydedildi ve push edildi"
            fi
          else
            echo "âš ï¸  guncel_baseurl.txt dosyasÄ± oluÅŸturulamadÄ±"
          fi
